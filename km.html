<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Void Racer 2D</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        body {
            margin: 0;
            overflow: hidden;
            background-color: #111;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Orbitron', sans-serif;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }
        #game-container {
            position: relative;
            width: 100%;
            max-width: 400px; /* Game's native width */
            aspect-ratio: 400 / 600;
            border: 2px solid #00ffff;
            box-shadow: 0 0 20px #00ffff, 0 0 40px #ff00ff;
        }
        canvas {
            display: block;
            background-color: #000;
            width: 100%;
            height: 100%;
        }
        .ui {
            position: absolute;
            color: white;
            text-shadow: 0 0 5px #ff00ff, 0 0 10px #ff00ff;
            pointer-events: none;
            width: 100%;
            text-align: center;
        }
        #score {
            top: 20px;
            font-size: 2em;
        }
        .modal {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 10, 0.85);
            border: 2px solid #00ffff;
            padding: 40px;
            border-radius: 12px;
            pointer-events: auto;
        }
        .modal h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #ff00ff;
        }
        .modal p {
            font-size: 1.2em;
            margin-bottom: 30px;
        }
        .difficulty-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .button {
            background: linear-gradient(45deg, #ff00ff, #00ffff);
            border: none;
            color: #ffffff;
            padding: 15px 30px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2em;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 0 0 10px #ff00ff;
            transition: all 0.1s ease-in-out;
        }
        .button:hover {
            box-shadow: 0 0 20px #00ffff;
        }
        #mobile-controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: none; /* Hidden by default, shown via JS for touch devices */
            justify-content: space-between;
            align-items: flex-end;
            padding: 0 20px;
            box-sizing: border-box;
            pointer-events: auto;
        }
        .d-pad, .action-pad {
            display: flex;
            gap: 20px;
        }
        .ctrl-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #00ffff;
            background: rgba(0, 255, 255, 0.2);
            color: white;
            font-size: 2em;
            text-align: center;
            line-height: 55px;
            user-select: none; /* Prevent text selection */
            -webkit-user-select: none;
            touch-action: manipulation; /* Improve touch responsiveness */
        }
        .ctrl-btn:active {
            background: rgba(255, 0, 255, 0.5);
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="score" class="ui">SCORE: 0</div>
        <div id="startModal" class="ui modal">
            <h1>VOID RACER 2D</h1>
            <p>Select your difficulty</p>
            <div class="difficulty-buttons">
                 <button id="easyBtn" class="button">EASY</button>
                 <button id="midBtn" class="button">MEDIUM</button>
                 <button id="hardBtn" class="button">HARD</button>
            </div>
        </div>
        <div id="gameOverModal" class="ui modal" style="display: none;">
            <h1>GAME OVER</h1>
            <p id="finalScore">FINAL SCORE: 0</p>
            <button id="restartButton" class="button">RESTART</button>
        </div>
        <div id="mobile-controls">
            <div class="d-pad">
                <button id="mobile-left" class="ctrl-btn">◀</button>
                <button id="mobile-right" class="ctrl-btn">▶</button>
            </div>
            <div class="action-pad">
                <button id="mobile-up" class="ctrl-btn">▲</button>
                <button id="mobile-down" class="ctrl-btn">▼</button>
            </div>
        </div>
    </div>

    <script>
    // --- SETUP ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const gameContainer = document.getElementById('game-container');

    const canvasWidth = 400;
    const canvasHeight = 600;
    canvas.width = canvasWidth;
    canvas.height = canvasHeight;

    // --- UI ELEMENTS ---
    const scoreUI = document.getElementById('score');
    const finalScoreUI = document.getElementById('finalScore');
    const startModal = document.getElementById('startModal');
    const gameOverModal = document.getElementById('gameOverModal');
    const easyBtn = document.getElementById('easyBtn');
    const midBtn = document.getElementById('midBtn');
    const hardBtn = document.getElementById('hardBtn');
    const restartButton = document.getElementById('restartButton');
    const mobileControls = document.getElementById('mobile-controls');
    const mobileUp = document.getElementById('mobile-up');
    const mobileDown = document.getElementById('mobile-down');
    const mobileLeft = document.getElementById('mobile-left');
    const mobileRight = document.getElementById('mobile-right');

    // --- GAME STATE & VARIABLES ---
    let gameState = 'menu'; // menu, playing, gameOver
    let keys = {};
    let score = 0;
    let difficulty = 'medium';
    let roadSpeed = 5;
    let player, opponents, roadMarkings, particles;
    
    // --- AUDIO ---
    const synth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: "square" },
        envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.1 }
    }).toDestination();
    const noiseSynth = new Tone.NoiseSynth({
        noise: { type: "white" },
        envelope: { attack: 0.005, decay: 0.1, sustain: 0 }
    }).toDestination();

    // --- VEHICLE MODELS (SVG Paths for a 3D look) ---
    const playerModel = {
        path: new Path2D("M20,0 L40,60 L30,55 L10,55 L0,60 Z M15,20 L25,20 L28,45 L12,45 Z"),
        shadow: new Path2D("M10,55 L30,55 L40,60 L20,65 L0,60 Z"),
        width: 40, height: 60,
        color: '#ffff00', cabinColor: '#00ffff'
    };
    const opponentModel = {
        path: new Path2D("M5,0 C-5,15 5,25 5,30 L35,30 C35,25 45,15 35,0 Z M5,30 L0,60 L10,55 L30,55 L40,60 L35,30 Z"),
        shadow: new Path2D("M10,55 L30,55 L40,60 L20,65 L0,60 Z"),
        width: 40, height: 60,
        color: '#ff0000', cabinColor: 'rgba(255,255,255,0.7)'
    };
    
    // --- CAR CLASS ---
    class Car {
        constructor(x, y, model, isPlayer = false) {
            this.x = x;
            this.y = y;
            this.model = model;
            this.width = model.width;
            this.height = model.height;
            this.isPlayer = isPlayer;
            this.speed = 4;
            this.crashed = false;
            
            // AI properties
            this.revengeTarget = null;
            this.revengeTimer = 0;
            this.baseSpeed = 0.8;
            if(!isPlayer) this.baseSpeed = 0.7 + Math.random() * 0.2; // Give AI varied speeds
        }

        draw() {
            if (this.crashed) return;
            ctx.save();
            ctx.translate(this.x, this.y);

            // Draw shadow
            ctx.fillStyle = 'rgba(0,0,0,0.4)';
            ctx.fill(this.model.shadow);
            
            // Draw body
            ctx.fillStyle = this.model.color;
            ctx.strokeStyle = '#eee';
            ctx.lineWidth = 1;
            ctx.fill(this.model.path);
            ctx.stroke(this.model.path);
            
            ctx.restore();
        }

        update() {
            if (this.isPlayer) {
                this.handlePlayerInput();
            } else {
                this.handleAI();
            }
        }

        handlePlayerInput() {
            if ((keys['ArrowLeft'] || keys['KeyA']) && this.x > 0) this.x -= this.speed;
            if ((keys['ArrowRight'] || keys['KeyD']) && this.x < canvasWidth - this.width) this.x += this.speed;
            if ((keys['ArrowUp'] || keys['KeyW']) && this.y > 0) this.y -= this.speed;
            if ((keys['ArrowDown'] || keys['KeyS']) && this.y < canvasHeight - this.height) this.y += this.speed;
        }

        handleAI() {
            this.y += roadSpeed * this.baseSpeed;

            if (this.revengeTimer > 0) {
                this.revengeTimer -= 1/60;
                const targetX = this.revengeTarget.x;
                if (this.x < targetX) this.x += 2;
                if (this.x > targetX) this.x -= 2;
            }

            if (this.y > canvasHeight) {
                this.y = -this.height - Math.random() * 300;
                this.x = Math.random() * (canvasWidth - this.width);
                this.revengeTimer = 0;
            }
        }
    }
    
    // --- PARTICLE CLASS ---
    class Particle {
        constructor(x, y, color) {
            this.x = x; this.y = y;
            this.vx = (Math.random() - 0.5) * 5;
            this.vy = (Math.random() - 0.5) * 5;
            this.size = Math.random() * 3 + 1;
            this.life = 100;
            this.color = color;
        }
        update() {
            this.x += this.vx;
            this.y += this.vy;
            this.life--;
        }
        draw() {
            ctx.fillStyle = this.color;
            ctx.globalAlpha = this.life / 100;
            ctx.fillRect(this.x, this.y, this.size, this.size);
            ctx.globalAlpha = 1.0;
        }
    }
    
    function createExplosion(x, y) {
        noiseSynth.triggerAttackRelease("0.2s");
        for(let i=0; i<50; i++) {
            particles.push(new Particle(x, y, `hsl(${Math.random() * 60}, 100%, 50%)`));
        }
    }

    // --- ROAD ---
    function createRoadMarkings() {
        roadMarkings = [];
        for (let i = 0; i < 10; i++) {
            roadMarkings.push({ x: canvasWidth / 3, y: i * 70, w: 5, h: 40 });
            roadMarkings.push({ x: canvasWidth * 2 / 3, y: i * 70, w: 5, h: 40 });
        }
    }

    function updateRoadMarkings() {
        roadMarkings.forEach(mark => {
            mark.y += roadSpeed;
            if (mark.y > canvasHeight) mark.y = -mark.h;
        });
    }

    function drawRoad() {
        ctx.fillStyle = 'white';
        roadMarkings.forEach(mark => ctx.fillRect(mark.x, mark.y, mark.w, mark.h));
    }

    // --- GAME LOGIC ---
    function init() {
        score = 0;
        particles = [];
        
        switch(difficulty) {
            case 'easy': roadSpeed = 4; break;
            case 'hard': roadSpeed = 6; break;
            default: roadSpeed = 5;
        }
        
        player = new Car(canvasWidth / 2 - 20, canvasHeight - 80, playerModel, true);
        
        opponents = [];
        const colors = ['#ff4444', '#44ff44', '#4444ff'];
        for(let i=0; i<3; i++) {
            const x = Math.random() * (canvasWidth - 40);
            const y = -60 - (i * 200) - Math.random() * 100;
            const model = {...opponentModel, color: colors[i]};
            opponents.push(new Car(x, y, model));
        }
        
        createRoadMarkings();
        scoreUI.textContent = "SCORE: 0";
    }

    function checkCollisions() {
        opponents.forEach(opponent => {
            if (
                !player.crashed &&
                player.x < opponent.x + opponent.width &&
                player.x + player.width > opponent.x &&
                player.y < opponent.y + opponent.height &&
                player.y + player.height > opponent.y
            ) {
                gameOver();
            }

            opponents.forEach(other => {
                if (opponent !== other && 
                    opponent.x < other.x + other.width && opponent.x + opponent.width > other.x &&
                    opponent.y < other.y + other.height && opponent.y + opponent.height > other.y
                ) {
                    if (opponent.x < other.x) opponent.x -= 1; else opponent.x += 1;
                }
            });
            
            if (!opponent.revengeTarget && 
                player.x < opponent.x + opponent.width + 20 && player.x + player.width > opponent.x - 20 &&
                player.y < opponent.y + opponent.height + 20 && player.y + player.height > opponent.y - 20
            ) {
                 if ((player.x < opponent.x && (keys['ArrowRight'] || keys['KeyD'])) || (player.x > opponent.x && (keys['ArrowLeft'] || keys['KeyA']))) {
                    opponent.revengeTarget = player;
                    opponent.revengeTimer = difficulty === 'hard' ? 5 : 3;
                    synth.triggerAttackRelease("C3", "8n");
                 }
            }
        });
    }

    function update() {
        if (player.crashed) {
            // only update particles and road after crash
             particles.forEach((p, i) => {
                p.update();
                if (p.life <= 0) particles.splice(i, 1);
            });
            updateRoadMarkings();
            return;
        };
        player.update();
        opponents.forEach(o => o.update());
        updateRoadMarkings();
        checkCollisions();

        particles.forEach((p, i) => {
            p.update();
            if (p.life <= 0) particles.splice(i, 1);
        });

        score += 1;
        roadSpeed += 0.001;
        scoreUI.textContent = `SCORE: ${score}`;
    }

    function draw() {
        ctx.clearRect(0, 0, canvasWidth, canvasHeight);
        drawRoad();
        player.draw();
        opponents.forEach(o => o.draw());
        particles.forEach(p => p.draw());
    }

    function gameLoop() {
        if (gameState === 'playing' || gameState === 'gameOver') {
            update();
            draw();
        }
        requestAnimationFrame(gameLoop);
    }
    
    function startGame() {
        Tone.start();
        init();
        gameState = 'playing';
        startModal.style.display = 'none';
        gameOverModal.style.display = 'none';
        gameLoop();
    }
    
    function gameOver() {
        if (player.crashed) return; // Prevent multiple calls
        createExplosion(player.x + player.width / 2, player.y + player.height / 2);
        player.crashed = true;
        
        setTimeout(() => {
            gameState = 'gameOver';
            finalScoreUI.textContent = `FINAL SCORE: ${score}`;
            gameOverModal.style.display = 'flex';
        }, 1000);
    }
    
    function setupMobileControls() {
        const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
        if (isTouch) {
            mobileControls.style.display = 'flex';
        }

        const addKey = (key) => (e) => { e.preventDefault(); keys[key] = true; };
        const removeKey = (key) => (e) => { e.preventDefault(); keys[key] = false; };

        // Left
        mobileLeft.addEventListener('touchstart', addKey('ArrowLeft'));
        mobileLeft.addEventListener('touchend', removeKey('ArrowLeft'));
        mobileLeft.addEventListener('mousedown', addKey('ArrowLeft'));
        mobileLeft.addEventListener('mouseup', removeKey('ArrowLeft'));
        mobileLeft.addEventListener('mouseleave', removeKey('ArrowLeft'));

        // Right
        mobileRight.addEventListener('touchstart', addKey('ArrowRight'));
        mobileRight.addEventListener('touchend', removeKey('ArrowRight'));
        mobileRight.addEventListener('mousedown', addKey('ArrowRight'));
        mobileRight.addEventListener('mouseup', removeKey('ArrowRight'));
        mobileRight.addEventListener('mouseleave', removeKey('ArrowRight'));

        // Up
        mobileUp.addEventListener('touchstart', addKey('ArrowUp'));
        mobileUp.addEventListener('touchend', removeKey('ArrowUp'));
        mobileUp.addEventListener('mousedown', addKey('ArrowUp'));
        mobileUp.addEventListener('mouseup', removeKey('ArrowUp'));
        mobileUp.addEventListener('mouseleave', removeKey('ArrowUp'));
        
        // Down
        mobileDown.addEventListener('touchstart', addKey('ArrowDown'));
        mobileDown.addEventListener('touchend', removeKey('ArrowDown'));
        mobileDown.addEventListener('mousedown', addKey('ArrowDown'));
        mobileDown.addEventListener('mouseup', removeKey('ArrowDown'));
        mobileDown.addEventListener('mouseleave', removeKey('ArrowDown'));
    }

    // --- EVENT LISTENERS ---
    setupMobileControls();
    
    window.addEventListener('keydown', e => keys[e.code] = true);
    window.addEventListener('keyup', e => keys[e.code] = false);
    
    easyBtn.addEventListener('click', () => { difficulty = 'easy'; startGame(); });
    midBtn.addEventListener('click', () => { difficulty = 'medium'; startGame(); });
    hardBtn.addEventListener('click', () => { difficulty = 'hard'; startGame(); });
    
    restartButton.addEventListener('click', () => {
        gameOverModal.style.display = 'none';
        startModal.style.display = 'flex';
        gameState = 'menu';
    });

    </script>
</body>
</html>

